<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/assertion.js | asyncmark</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="A benchmarking library that supports Promise."><meta property="twitter:card" content="summary"><meta property="twitter:title" content="asyncmark"><meta property="twitter:description" content="A benchmarking library that supports Promise."></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/macrat/AsyncMark"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/benchmark.js~Benchmark.html">Benchmark</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/result.js~Result.html">Result</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/suite.js~Suite.html">Suite</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-timeit">timeit</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/assertion.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import assert from &apos;assert&apos;;


/**
 * Generate {@link AssertionError}
 *
 * @param {AssertRule} rule - the rule that couses error.
 * @param {Result} result - the result for assert.
 * @param {function} [stackStartFn] - provided function will remove from stack trace.
 *
 * @return {assert.AssertionError} generated error
 *
 * @ignore
 * @since 0.3.0
 */
function AssertionError(rule, result, stackStartFn) {
    return new assert.AssertionError({
        message: `benchmark &quot;${result.name}&quot;: actual:${result.average}msec/op ${rule.operator} expected:${rule.expected}msec/op`,
        actual: `${result.average} msec/op`,
        expected: `${rule.expected} msec/op`,
        operator: rule.operator,
        stackStartFn: stackStartFn || rule.assert,
    });
}


/**
 * Generate alternate error with default {@link Error}
 *
 * @param {AssertRule} rule - the rule that couses error.
 * @param {Result} result - the result for assert.
 * @param {function} [stackStartFn] - provided function will remove from stack trace.
 *
 * @return {Error} generated error
 *
 * @ignore
 * @since 0.3.0
 */
function AlternateError(rule, result, stackStartFn) {
    return Object.assign(
        new Error(`benchmark &quot;${result.name}&quot;: actual:${result.average}msec/op ${rule.operator} expected:${rule.expected}msec/op`),
        {
            actual: `${result.average} msec/op`,
            expected: `${rule.expected} msec/op`,
            operator: rule.operator,
        }
    );
}


/**
 * Convert unit to number
 *
 * @example
 * assert(100 * unit(&apos;ms&apos;) == 0.1 * unit(&apos;sec&apos;))
 *
 * @param {Number} u - unit name like &apos;ms&apos;, &apos;sec&apos; or etc.
 *
 * @return {Number} number to convert milliseconds.
 *
 * @since 0.3.0
 * @ignore
 */
function unit(u) {
    switch (u) {
    case &apos;s&apos;:
    case &apos;sec&apos;:
        return 1e3;

    case &apos;&apos;:
    case &apos;ms&apos;:
    case &apos;msec&apos;:
        return 1;

    case &apos;us&apos;:
    case &apos;usec&apos;:
        return 1e-3;

    case &apos;ns&apos;:
    case &apos;nsec&apos;:
        return 1e-6;

    default:
        throw Error(`unknown unit name: &quot;${u}&quot;`);
    }
}


/**
 * The assertion rule
 *
 * @since 0.3.0
 */
class AssertRule {
    /**
     * Parse time rule for assertion.
     *
     * Rule format is `{operator}{number}{unit}`; use like `&lt;=10msec`.
     * Operator and unit are can omit. If omitted, uses `&lt;=` and `msec`.
     *
     * Supported operators
     * |`&lt;42`|faster than 42 msec|
     * |`&lt;=42` or omit|42 msec or faster|
     * |`&gt;42`|slower than 42 msec|
     * |`&gt;=42`|42 msec or slower|
     *
     * Supported units
     * |`42s` or `42sec`|seconds|
     * |`42ms` or `42msec`|milliseconds|
     * |`42us` or `42usec`|microseconds|
     * |`42ns` or `42nsec`|nanoseconds|
     *
     * @param {Number|String} rule - assert rule that milliseconds {@link Number} or {@String} value like &apos;&lt;10ms&apos; or &apos;&gt;=20s&apos;.
     */
    constructor(rule) {
        const m = String(rule).match(/^(|[&lt;&gt;]=?)(\d+(?:\.\d+)?)(|s|ms|us|ns|sec|msec|usec|nsec)$/);
        if (m === null) {
            throw Error(`Invalid rule format: &quot;${rule}&quot;`);
        }

        /**
         * @type {string} operator string that set in rule.
         */
        this.operator = m[1] || &apos;&lt;=&apos;;

        /**
         * @type {number} the threshold time in milliseconds.
         */
        this.expected = Number(m[2]) * unit(m[3]);

        /**
         * @type {function} error object generator.
         * @ignore
         */
        this.errorFn = assert !== undefined ? AssertionError : AlternateError;
    }

    /**
     * Checking benchmark result.
     *
     * @param {Number} msec - target milliseconds.
     *
     * @return {Boolean} returns true if msec is acceptable.
     */
    check(msec) {
        return {
            &apos;&lt;&apos;: ms =&gt; ms &lt; this.expected,
            &apos;&lt;=&apos;: ms =&gt; ms &lt;= this.expected,
            &apos;&gt;&apos;: ms =&gt; ms &gt; this.expected,
            &apos;&gt;=&apos;: ms =&gt; ms &gt;= this.expected,
        }[this.operator](msec);
    }

    /**
     * Assert with benchmark result.
     *
     * @param {Result} result - result of benchmark.
     * @param {function} [stackStartFn] - provided function will remove from stack trace.
     *
     * @throw {assert.AssertionError} when result is unacceptable.
     * @return {undefined}
     *
     * @since 0.3.0
     */
    assert(result, stackStartFn=null) {
        if (!this.check(result.average)) {
            throw this.errorFn(this, result, stackStartFn);
        }
    }
}


export {AssertRule as default, unit, AssertionError, AlternateError};
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
