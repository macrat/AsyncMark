<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">test/benchmark.js | asyncmark</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="A benchmarking library that supports Promise."><meta property="twitter:card" content="summary"><meta property="twitter:title" content="asyncmark"><meta property="twitter:description" content="A benchmarking library that supports Promise."></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/macrat/AsyncMark"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/benchmark.js~Benchmark.html">Benchmark</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/result.js~Result.html">Result</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/suite.js~Suite.html">Suite</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-timeit">timeit</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">test/benchmark.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import assert from &apos;power-assert&apos;;

import Benchmark, {Benchmark as Bench2, Result} from &apos;../src&apos;;


/**
 * @test {Benchmark}
 */
describe(&apos;Benchmark&apos;, function() {
    it(&apos;module exports&apos;, function() {
        assert(Benchmark === Bench2);
    });

    /**
     * @test {Benchmark#constructor}
     */
    describe(&apos;#constructor&apos;, function() {
        it(&apos;default values&apos;, function() {
            const b = new Benchmark();

            assert(b.name === &apos;unnamed&apos;);
            assert(b.targetErrorRate === 0.1);
            assert(b.maxNumber === 10000);
            assert(b.minNumber === 30);
            assert(b.number === null);
        });

        it(&apos;function argument&apos;, function() {
            let called = false;
            const f = function() {
                called = true;
            }
            const b = new Benchmark(f);

            assert(b.fun === f);

            assert(called === false);
            b.fun();
            assert(called === true);
        });

        describe(&apos;object argument&apos;, function() {
            it(&apos;with auto number&apos;, function() {
                const conf = {
                    name: &apos;test name&apos;,
                    targetErrorRate: 0.2,
                    maxNumber: 100,
                    minNumber: 10,
                };
                const b = new Benchmark(conf);

                assert(b.name === conf.name);
                assert(b.targetErrorRate === conf.targetErrorRate);
                assert(b.maxNumber === conf.maxNumber);
                assert(b.minNumber === conf.minNumber);
            });

            it(&apos;with specify number&apos;, function() {
                const conf = {
                    name: &apos;test name&apos;,
                    number: 42,
                };
                const b = new Benchmark(conf);

                assert(b.name === conf.name);
                assert(b.number === conf.number);
            });

            it(&apos;functions&apos;, function() {
                const called = {
                    before: false,
                    beforeEach: false,
                    fun: false,
                    afterEach: false,
                    after: false,
                };
                const conf = {
                    name: &apos;test name&apos;,
                    number: 42,
                    before() {
                        called.before = true;
                    },
                    beforeEach() {
                        called.beforeEach = true;
                    },
                    fun() {
                        called.fun = true;
                    },
                    afterEach() {
                        called.afterEach = true;
                    },
                    after() {
                        called.after = true;
                    },
                };
                const b = new Benchmark(conf);

                assert(b.name === conf.name);
                assert(b.number === conf.number);

                assert(called.before === false);
                b.before();
                assert(called.before === true);

                assert(called.beforeEach === false);
                b.beforeEach();
                assert(called.beforeEach === true);

                assert(called.fun === false);
                b.fun();
                assert(called.fun === true);

                assert(called.afterEach === false);
                b.afterEach();
                assert(called.afterEach === true);

                assert(called.after === false);
                b.after();
                assert(called.after === true);
            });
        });
    });

    /**
     * @test {Benchmark#fun}
     */
    describe(&apos;#fun&apos;, function() {
        it(&apos;default behavior&apos;, async function() {
            const b = new Benchmark();

            const err = await b.fun().then(() =&gt; null).catch(e =&gt; e);
            assert(err !== null, &apos;excepted error but not throwed&apos;);
            assert(err.message === &apos;target function is not defined&apos;);
        });
    });

    /**
     * @test {Benchmark#after}
     */
    describe(&apos;#after&apos;, function() {
        it(&apos;default behavior&apos;, async function() {
            const l = console.log;
            const messages = [];
            console.log = function() {
                messages.push([...arguments].map(x =&gt; String(x)).join(&apos; &apos;));
            }

            try {
                const b = new Benchmark();
                const r = new Result(&apos;after_test&apos;, [1, 2, 3, 4, 5, 100])

                await b.after(r);

                assert.deepStrictEqual(messages, [new Result(&apos;after_test&apos;, [1, 2, 3, 4, 5]).toString()]);
            } finally {
                console.log = l;
            }
        });
    });

    /**
     * @test {Benchmark#run}
     */
    describe(&apos;#run&apos;, function() {
        it(&apos;call methods order&apos;, async function() {
            const callLog = [];

            const conf = {
                number: 2,
                before() { callLog.push(&apos;before&apos;); },
                beforeEach() { callLog.push(&apos;beforeEach&apos;); },
                fun() { callLog.push(&apos;fun&apos;); },
                afterEach() { callLog.push(&apos;afterEach&apos;); },
                after() { callLog.push(&apos;after&apos;); },
            };
            const b = new Benchmark(conf);

            const l = console.log;
            const messages = [];
            console.log = function() {
                messages.push([...arguments].map(x =&gt; String(x)).join(&apos; &apos;));
            }

            try {
                await b.run();

                assert.deepStrictEqual(callLog, [
                    &apos;before&apos;,
                    &apos;beforeEach&apos;,
                    &apos;fun&apos;,
                    &apos;afterEach&apos;,
                    &apos;beforeEach&apos;,
                    &apos;fun&apos;,
                    &apos;afterEach&apos;,
                    &apos;after&apos;,
                ]);
                assert.deepStrictEqual(messages, []);
            } finally {
                console.log = l;
            }
        });

        it(&apos;call methods order (with callbacks)&apos;, async function() {
            const callLog = [];

            const conf = {
                number: 2,
                before() { callLog.push(&apos;before&apos;); },
                beforeEach() { callLog.push(&apos;beforeEach&apos;); },
                fun() { callLog.push(&apos;fun&apos;); },
                afterEach() { callLog.push(&apos;afterEach&apos;); },
                after() { callLog.push(&apos;after&apos;); },
            };
            const b = new Benchmark(conf);

            const l = console.log;
            const messages = [];
            console.log = function() {
                messages.push([...arguments].map(x =&gt; String(x)).join(&apos; &apos;));
            }

            try {
                await b.run({}, {
                    beforeTest() { callLog.push(&apos;beforeTest&apos;); },
                    afterTest() { callLog.push(&apos;afterTest&apos;); },
                });

                assert.deepStrictEqual(callLog, [
                    &apos;before&apos;,
                    &apos;beforeTest&apos;,
                    &apos;beforeEach&apos;,
                    &apos;fun&apos;,
                    &apos;afterEach&apos;,
                    &apos;afterTest&apos;,
                    &apos;beforeTest&apos;,
                    &apos;beforeEach&apos;,
                    &apos;fun&apos;,
                    &apos;afterEach&apos;,
                    &apos;afterTest&apos;,
                    &apos;after&apos;,
                ]);
                assert.deepStrictEqual(messages, []);
            } finally {
                console.log = l;
            }
        });

        it(&apos;context handling&apos;, async function() {
            const conf = {
                number: 2,
                before() {
                    assert(this.inOuter === undefined);
                    assert(this.inInner === undefined);
                    assert(this.inFunc === undefined);
                    assert(this.outInner === undefined);
                    assert(this.outOuter === undefined);

                    this.inOuter = 123;
                },
                beforeEach() {
                    assert(this.inOuter === 123);
                    assert(this.inInner === undefined);
                    assert(this.inFunc === undefined);
                    assert(this.outInner === undefined);
                    assert(this.outOuter === undefined);

                    this.inInner = &apos;abc&apos;;
                },
                fun() {
                    assert(this.inOuter === 123);
                    assert(this.inInner === &apos;abc&apos;);
                    assert(this.inFunc === undefined);
                    assert(this.outInner === undefined);
                    assert(this.outOuter === undefined);

                    this.inFunc = true;
                },
                afterEach() {
                    assert(this.inOuter === 123);
                    assert(this.inInner === &apos;abc&apos;);
                    assert(this.inFunc === true);
                    assert(this.outInner === undefined);
                    assert(this.outOuter === undefined);

                    this.outInner = &apos;cba&apos;;
                },
                after() {
                    assert(this.inOuter === 123);
                    assert(this.inInner === undefined);
                    assert(this.inFunc === undefined);
                    assert(this.outInner === undefined);
                    assert(this.outOuter === undefined);

                    this.outOuter = 321;
                },
            };
            const b = new Benchmark(conf);

            const l = console.log;
            const messages = [];
            console.log = function() {
                messages.push([...arguments].map(x =&gt; String(x)).join(&apos; &apos;));
            }

            try {
                await b.run({}, {
                    beforeTest() {
                        assert(this.inOuter === 123);
                        assert(this.inInner === undefined);
                        assert(this.inFunc === undefined);
                        assert(this.outInner === undefined);
                        assert(this.outOuter === undefined);
                    },
                    afterTest() {
                        assert(this.inOuter === 123);
                        assert(this.inInner === &apos;abc&apos;);
                        assert(this.inFunc === true);
                        assert(this.outInner === &apos;cba&apos;);
                        assert(this.outOuter === undefined);
                    },
                });
                assert.deepStrictEqual(messages, []);
            } finally {
                console.log = l;
            }
        });

        it(&apos;arguments for methods&apos;, async function() {
            const beforeCounts = [];
            const afterCounts = [];

            const b = new Benchmark({
                number: 2,
                before() {
                    assert(arguments.length === 0);
                },
                beforeEach(count) {
                    assert(arguments.length === 1);

                    assert(typeof count === &apos;number&apos;);
                    beforeCounts.push(count);
                },
                fun() {
                    assert(arguments.length === 0);
                },
                afterEach(count, msec) {
                    assert(arguments.length === 2);

                    assert(typeof msec === &apos;number&apos;);
                    assert(msec &lt; 1);

                    assert(typeof count === &apos;number&apos;);
                    afterCounts.push(count);
                },
                after(result) {
                    assert(arguments.length === 1);

                    assert(result instanceof Result);
                    assert(result.msecs.length === 2)
                },
            });

            const result = await b.run({}, {
                beforeTest(count, bench) {
                    assert(typeof count === &apos;number&apos;);
                    assert(bench instanceof Benchmark);
                },
                afterTest(count, bench, msec) {
                    assert(typeof count === &apos;number&apos;);
                    assert(bench instanceof Benchmark);
                    assert(typeof msec === &apos;number&apos;);
                    assert(msec &lt; 1);
                },
            });
            assert(result instanceof Result);
            assert(result.msecs.length === 2);

            assert.deepStrictEqual(beforeCounts, [0, 1]);
            assert.deepStrictEqual(afterCounts, [0, 1]);
        });

        describe(&apos;loop and time&apos;, function() {
            it(&apos;static number&apos;, async function() {
                const r100 = await new Benchmark({
                    number: 3,
                    fun() {
                        return new Promise((resolve, reject) =&gt; setTimeout(resolve, 100));
                    },
                    after() {}
                }).run();
                assert(Math.abs(r100.average - 100) &lt;= 3);

                const r42 = await new Benchmark({
                    number: 3,
                    fun() {
                        return new Promise((resolve, reject) =&gt; setTimeout(resolve, 42));
                    },
                    after() {}
                }).run();
                assert(Math.abs(r42.average - 42) &lt;= 3);
            });

            it(&apos;auto / rate 20%&apos;, async function() {
                const r = await new Benchmark({
                    minNumber: 5,
                    maxNumber: 100,
                    targetErrorRate: 0.2,
                    fun() {
                        return new Promise((resolve, reject) =&gt; setTimeout(resolve, 49 + Math.random() * 2));
                    },
                    after() {},
                }).run();

                assert(r.msecs.length &gt;= 5);
                assert(r.msecs.length &lt;= 100);
                assert(r.errorRate &lt;= 0.2);
            });

            it(&apos;auto / rate 40%&apos;, async function() {
                const r = await new Benchmark({
                    minNumber: 5,
                    maxNumber: 100,
                    targetErrorRate: 0.4,
                    fun() {
                        return new Promise((resolve, reject) =&gt; setTimeout(resolve, 49 + Math.random() * 2));
                    },
                    after() {},
                }).run();

                assert(r.msecs.length &gt;= 5);
                assert(r.msecs.length &lt;= 100);
                assert(r.errorRate &lt;= 0.4);
            });
        });
    });
});
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
